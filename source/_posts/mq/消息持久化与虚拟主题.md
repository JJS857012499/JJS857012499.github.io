---
title: 消息持久化与虚拟主题
date: 2019-03-13 15:58:52
category: mq
tags: [mq，持久化，虚拟主题，topic]
---

# 背景
topic消息一般是没有持久化的，如果在消费的应用启动之前就已经发送了topic消息，消费者是无法消费该消息的；并且如果在分布式多机部署的情况下，一个topic 会被相同的应用消费多次。解决上面的问题需要持久化topic以及使用virtual topic
<!-- more -->

# topic 持久化
修改 activemq_home/config 目录下 activemq.xml  broker 标签添加 persistent="true"属性
```   
   <!--
        The <broker> element is used to configure the ActiveMQ broker.
    -->
    <broker xmlns="http://activemq.apache.org/schema/core" brokerName="localhost" persistent="true"  dataDirectory="${activemq.data}">
```
activemq 默认使用 kahaDB 做持久化 数据存放在 acivemq_home/data/kahaDB 目录下

持久化topic的listenerContainerFactory必须设置 setSubscriptionDurable(true)  setPubSubDomain(true) 并且设置clientId
注意：不同的destination 需要的listenerContainerFactory 的 clientId必须不同，所以clientId最好根据业务类型来命名。相同的destination在分布式部署下如果clientId 相同则后启动的应用无法消费该desination(如果之前启动的应用关闭后，后启动的应用可以消费该destination)。所以要添加 新的destination 的消费者，必须要新建对应的listenerContainerFactory，并且clientId不同
> 如果用ConnectionFactory用的是CachingConnectionFactory,并且设置了clientId,则监听就会抛出错误：Cause: setClientID call not supported on proxy for shared Connection. Set the 'clientId' property on the SingleConnectionFactory instead
用了setclientId，ConnectionFactory应该用SingleConnectionFactory代替

[https://stackoverflow.com/questions/21984319/why-defaultmessagelistenercontainer-should-not-use-cachingconnectionfactory#](https://stackoverflow.com/questions/21984319/why-defaultmessagelistenercontainer-should-not-use-cachingconnectionfactory#)
[https://www.cnblogs.com/xingzc/p/5943165.html](https://www.cnblogs.com/xingzc/p/5943165.html)


# 虚拟主题（Virtual Topics）
功能：虚拟主题类似于1对多的分支功能+消费端的cluster+failover
原理：通过queue 实现的，在分布式部署下，相同的destination不会被重复消费

* 虚拟topic的名字必须以VirtualTopic.前缀开始（可以通过改变activemq_home/conf 下 activemq.xml配置修改 ）

* 虚拟topic 的destination 必须已Consumer.*.VirtualTopic.前缀开始（可以通过改变activemq_home/conf 下 activemq.xml配置修改 ） *号相当于分组

eg：如果队列名称为 VirtualTopic.Orders，detination 为 Consumer.A.VirtualTopic.Orders、Consumer.B.VirtualTopic.Orders在分布式部署下Consumer.A.VirtualTopic.Orders 只会被消费一次 Consumer.B.VirtualTopic.Orders也只会消费一次

